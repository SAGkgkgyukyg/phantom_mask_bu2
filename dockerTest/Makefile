# Phantom Mask Backend - Makefile (ä¿®æ­£ç‰ˆ)
# ç°¡åŒ– Docker Compose æ“ä½œçš„ä¾¿æ·å·¥å…·

.PHONY: help setup up down restart logs build clean db-backup db-restore dev prod test validate-tools

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help

# é¡è‰²å®šç¾©
RED := \033[31m
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
RESET := \033[0m

# å°ˆæ¡ˆåç¨±
PROJECT_NAME := phantom_mask

# Docker Compose å‘½ä»¤ï¼ˆè‡ªå‹•åµæ¸¬ï¼‰
DOCKER_COMPOSE := $(shell if command -v docker-compose >/dev/null 2>&1; then echo "docker-compose"; else echo "docker compose"; fi)

help: ## é¡¯ç¤ºæ­¤å¹«åŠ©è¨Šæ¯
	@echo "$(BLUE)Phantom Mask Backend - Docker Compose ç®¡ç†å·¥å…·$(RESET)"
	@echo ""
	@echo "$(GREEN)ä½¿ç”¨æ–¹å¼:$(RESET) make [ç›®æ¨™]"
	@echo ""
	@echo "$(YELLOW)ğŸ—ï¸ åˆ†é›¢å¼æ¶æ§‹ (æ¨è–¦):$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^(db-|backend-|separated-).*:.*?## / {printf "  $(BLUE)%-20s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(YELLOW)ğŸ”„ æ•´åˆå¼æ¶æ§‹ (å‚³çµ±):$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / && !/^(db-|backend-|separated-|help|validate-).*:.*?## / {printf "  $(BLUE)%-20s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(YELLOW)ğŸ”§ ç³»çµ±å·¥å…·:$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^validate-.*:.*?## / {printf "  $(BLUE)%-20s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""

validate-tools: ## ğŸ”§ é©—è­‰æ‰€éœ€å·¥å…·æ˜¯å¦å¯ç”¨
	@echo "$(BLUE)ğŸ”§ é©—è­‰ç³»çµ±å·¥å…·...$(RESET)"
	@echo ""
	@echo "$(YELLOW)æª¢æŸ¥ Docker:$(RESET)"
	@if command -v docker >/dev/null 2>&1; then \
		echo "$(GREEN)âœ… Docker: $(shell docker --version)$(RESET)"; \
	else \
		echo "$(RED)âŒ Docker æœªå®‰è£$(RESET)"; \
		exit 1; \
	fi
	@echo ""
	@echo "$(YELLOW)æª¢æŸ¥ Docker Compose:$(RESET)"
	@if command -v docker-compose >/dev/null 2>&1; then \
		echo "$(GREEN)âœ… docker-compose: $(shell docker-compose --version)$(RESET)"; \
		echo "$(BLUE)ä½¿ç”¨å‘½ä»¤: docker-compose$(RESET)"; \
	elif docker compose version >/dev/null 2>&1; then \
		echo "$(GREEN)âœ… docker compose: $(shell docker compose version)$(RESET)"; \
		echo "$(BLUE)ä½¿ç”¨å‘½ä»¤: docker compose$(RESET)"; \
	else \
		echo "$(RED)âŒ Docker Compose æœªå®‰è£$(RESET)"; \
		exit 1; \
	fi
	@echo ""
	@echo "$(YELLOW)æª¢æŸ¥å…¶ä»–å·¥å…·:$(RESET)"
	@if command -v curl >/dev/null 2>&1; then \
		echo "$(GREEN)âœ… curl: $(shell curl --version | head -n1)$(RESET)"; \
	else \
		echo "$(YELLOW)âš ï¸  curl æœªå®‰è£ (å½±éŸ¿å¥åº·æª¢æŸ¥åŠŸèƒ½)$(RESET)"; \
	fi
	@if command -v git >/dev/null 2>&1; then \
		echo "$(GREEN)âœ… git: $(shell git --version)$(RESET)"; \
	else \
		echo "$(YELLOW)âš ï¸  git æœªå®‰è£ (å½±éŸ¿æ›´æ–°åŠŸèƒ½)$(RESET)"; \
	fi
	@echo ""
	@echo "$(GREEN)ğŸ‰ å·¥å…·é©—è­‰å®Œæˆï¼ä½¿ç”¨å‘½ä»¤: $(DOCKER_COMPOSE)$(RESET)"

# ==========================================
# ğŸ—ï¸ åˆ†é›¢å¼æ¶æ§‹å‘½ä»¤ (æ¨è–¦ä½¿ç”¨)
# ==========================================

separated-init: validate-tools ## ğŸš€ åˆå§‹åŒ–åˆ†é›¢å¼ç’°å¢ƒ (è³‡æ–™åº«+ç¶²è·¯)
	@echo "$(GREEN)ğŸ—ï¸ åˆå§‹åŒ–åˆ†é›¢å¼æ¶æ§‹ç’°å¢ƒ...$(RESET)"
	@if [ ! -f .env ]; then \
		cp .env.example .env && \
		echo "$(YELLOW)ğŸ“‹ å·²å»ºç«‹ .env æª”æ¡ˆï¼Œè«‹ä¿®æ”¹å…¶ä¸­çš„è¨­å®šå€¼$(RESET)"; \
	fi
	@mkdir -p backups
	@echo "$(BLUE)ğŸŒ å»ºç«‹å…±ç”¨ç¶²è·¯...$(RESET)"
	@docker network create phantom_network 2>/dev/null || echo "$(YELLOW)ç¶²è·¯ phantom_network å·²å­˜åœ¨$(RESET)"
	@make db-start
	@make _init-db-if-needed
	@echo "$(GREEN)âœ… åˆ†é›¢å¼ç’°å¢ƒåˆå§‹åŒ–å®Œæˆï¼$(RESET)"
	@echo "$(BLUE)ğŸ’¡ æ¥ä¸‹ä¾†å¯ä»¥ä½¿ç”¨ 'make backend-start' å•Ÿå‹•å¾Œç«¯æœå‹™$(RESET)"

db-start: ## ğŸ—„ï¸ å•Ÿå‹•ç¨ç«‹è³‡æ–™åº«æœå‹™
	@echo "$(GREEN)ğŸ—„ï¸ å•Ÿå‹•ç¨ç«‹è³‡æ–™åº«æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml up -d
	@echo "$(GREEN)âœ… è³‡æ–™åº«æœå‹™å•Ÿå‹•å®Œæˆï¼$(RESET)"
	@make _wait-for-db

db-stop: ## ğŸ›‘ åœæ­¢è³‡æ–™åº«æœå‹™ (ä¿ç•™è³‡æ–™)
	@echo "$(YELLOW)ğŸ›‘ åœæ­¢è³‡æ–™åº«æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml stop
	@echo "$(GREEN)âœ… è³‡æ–™åº«æœå‹™å·²åœæ­¢$(RESET)"

db-restart: ## ğŸ”„ é‡æ–°å•Ÿå‹•è³‡æ–™åº«æœå‹™
	@echo "$(YELLOW)ğŸ”„ é‡æ–°å•Ÿå‹•è³‡æ–™åº«æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml restart
	@make _wait-for-db
	@echo "$(GREEN)âœ… è³‡æ–™åº«æœå‹™é‡æ–°å•Ÿå‹•å®Œæˆï¼$(RESET)"

db-logs: ## ğŸ“‹ æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ
	@echo "$(BLUE)ğŸ“‹ æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ:$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml logs -f

db-shell: ## ğŸš é€£æ¥åˆ°ç¨ç«‹è³‡æ–™åº«
	@echo "$(BLUE)ğŸš é€£æ¥åˆ°ç¨ç«‹è³‡æ–™åº«...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml exec db psql -U $${DB_USERNAME:-phantom_user} -d $${DB_NAME:-phantom_mask_db}

db-backup-auto: ## ğŸ’¾ è‡ªå‹•å‚™ä»½è³‡æ–™åº« (å«æ™‚é–“æˆ³è¨˜)
	@echo "$(GREEN)ğŸ’¾ å»ºç«‹è‡ªå‹•è³‡æ–™åº«å‚™ä»½...$(RESET)"
	@mkdir -p backups
	@BACKUP_FILE="backups/auto_backup_$(shell date +%Y%m%d_%H%M%S).sql"; \
	$(DOCKER_COMPOSE) -f docker-compose.db.yml exec -T db pg_dump -U $${DB_USERNAME:-phantom_user} $${DB_NAME:-phantom_mask_db} > $$BACKUP_FILE; \
	if [ $$? -eq 0 ]; then \
		echo "$(GREEN)âœ… å‚™ä»½æˆåŠŸå„²å­˜è‡³: $$BACKUP_FILE$(RESET)"; \
		echo "$(BLUE)ğŸ“Š å‚™ä»½æª”æ¡ˆå¤§å°: $(shell du -h $$BACKUP_FILE 2>/dev/null | cut -f1 || echo 'unknown')$(RESET)"; \
	else \
		echo "$(RED)âŒ å‚™ä»½å¤±æ•—ï¼$(RESET)"; \
		rm -f $$BACKUP_FILE; \
		exit 1; \
	fi

db-restore-latest: ## ğŸ“¥ é‚„åŸæœ€æ–°çš„è‡ªå‹•å‚™ä»½
	@echo "$(GREEN)ğŸ“¥ å°‹æ‰¾æœ€æ–°çš„å‚™ä»½æª”æ¡ˆ...$(RESET)"
	@LATEST_BACKUP=$$(ls -t backups/auto_backup_*.sql 2>/dev/null | head -n1); \
	if [ -z "$$LATEST_BACKUP" ]; then \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°è‡ªå‹•å‚™ä»½æª”æ¡ˆï¼$(RESET)"; \
		exit 1; \
	fi; \
	echo "$(BLUE)ğŸ“ æ‰¾åˆ°æœ€æ–°å‚™ä»½: $$LATEST_BACKUP$(RESET)"; \
	echo "$(YELLOW)âš ï¸  è­¦å‘Šï¼šé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™åº«ï¼$(RESET)"; \
	read -p "ç¢ºå®šè¦é‚„åŸè³‡æ–™åº«å—ï¼Ÿ(y/N) " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		echo "$(GREEN)ğŸ“¥ é‚„åŸè³‡æ–™åº«...$(RESET)"; \
		$(DOCKER_COMPOSE) -f docker-compose.db.yml exec -T db psql -U $${DB_USERNAME:-phantom_user} -d $${DB_NAME:-phantom_mask_db} < $$LATEST_BACKUP; \
		if [ $$? -eq 0 ]; then \
			echo "$(GREEN)âœ… è³‡æ–™åº«é‚„åŸå®Œæˆï¼$(RESET)"; \
		else \
			echo "$(RED)âŒ è³‡æ–™åº«é‚„åŸå¤±æ•—ï¼$(RESET)"; \
			exit 1; \
		fi; \
	else \
		echo "$(BLUE)âŒ å·²å–æ¶ˆé‚„åŸæ“ä½œ$(RESET)"; \
	fi

backend-start: ## ğŸš€ å•Ÿå‹•å¾Œç«¯æœå‹™ (éœ€è¦ç¨ç«‹è³‡æ–™åº«å·²é‹è¡Œ)
	@echo "$(GREEN)ğŸš€ å•Ÿå‹•å¾Œç«¯æœå‹™...$(RESET)"
	@make _check-db-running
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml up -d --build
	@echo "$(GREEN)âœ… å¾Œç«¯æœå‹™å•Ÿå‹•å®Œæˆï¼$(RESET)"
	@make _wait-for-backend

backend-stop: ## ğŸ›‘ åœæ­¢å¾Œç«¯æœå‹™
	@echo "$(YELLOW)ğŸ›‘ åœæ­¢å¾Œç«¯æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml stop
	@echo "$(GREEN)âœ… å¾Œç«¯æœå‹™å·²åœæ­¢$(RESET)"

backend-restart: ## ğŸ”„ é‡æ–°å•Ÿå‹•å¾Œç«¯æœå‹™
	@echo "$(YELLOW)ğŸ”„ é‡æ–°å•Ÿå‹•å¾Œç«¯æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml restart
	@make _wait-for-backend
	@echo "$(GREEN)âœ… å¾Œç«¯æœå‹™é‡æ–°å•Ÿå‹•å®Œæˆï¼$(RESET)"

backend-rebuild: ## ğŸ”¨ å®‰å…¨é‡å»ºå¾Œç«¯ (è‡ªå‹•å‚™ä»½â†’é‡å»ºâ†’é©—è­‰)
	@echo "$(GREEN)ğŸ”¨ é–‹å§‹å®‰å…¨é‡å»ºå¾Œç«¯æœå‹™...$(RESET)"
	@echo "$(BLUE)ğŸ“‹ æ­¥é©Ÿ 1/5: å»ºç«‹å‚™ä»½...$(RESET)"
	@make db-backup-auto
	@echo "$(BLUE)ğŸ“‹ æ­¥é©Ÿ 2/5: åœæ­¢èˆŠçš„å¾Œç«¯æœå‹™...$(RESET)"
	@make backend-stop 2>/dev/null || true
	@echo "$(BLUE)ğŸ“‹ æ­¥é©Ÿ 3/5: é‡æ–°å»ºç½®æ˜ åƒæª”...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml build --no-cache
	@echo "$(BLUE)ğŸ“‹ æ­¥é©Ÿ 4/5: å•Ÿå‹•æ–°çš„å¾Œç«¯æœå‹™...$(RESET)"
	@make backend-start
	@echo "$(BLUE)ğŸ“‹ æ­¥é©Ÿ 5/5: é©—è­‰æœå‹™ç‹€æ…‹...$(RESET)"
	@make separated-health
	@echo "$(GREEN)ğŸ‰ å¾Œç«¯æœå‹™å®‰å…¨é‡å»ºå®Œæˆï¼$(RESET)"

backend-logs: ## ğŸ“‹ æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ
	@echo "$(BLUE)ğŸ“‹ æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ:$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml logs -f

backend-shell: ## ğŸš é€²å…¥å¾Œç«¯å®¹å™¨
	@echo "$(BLUE)ğŸš é€²å…¥å¾Œç«¯å®¹å™¨...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml exec backend sh

separated-status: ## ğŸ“Š æŸ¥çœ‹åˆ†é›¢å¼æœå‹™ç‹€æ…‹
	@echo "$(BLUE)ğŸ“Š åˆ†é›¢å¼æœå‹™ç‹€æ…‹:$(RESET)"
	@echo ""
	@echo "$(YELLOW)è³‡æ–™åº«æœå‹™:$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml ps 2>/dev/null || echo "$(RED)âŒ è³‡æ–™åº«æœå‹™æœªé‹è¡Œ$(RESET)"
	@echo ""
	@echo "$(YELLOW)å¾Œç«¯æœå‹™:$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml ps 2>/dev/null || echo "$(RED)âŒ å¾Œç«¯æœå‹™æœªé‹è¡Œ$(RESET)"
	@echo ""

separated-health: ## ğŸ¥ æª¢æŸ¥åˆ†é›¢å¼æœå‹™å¥åº·ç‹€æ…‹
	@echo "$(BLUE)ğŸ¥ æª¢æŸ¥åˆ†é›¢å¼æœå‹™å¥åº·ç‹€æ…‹...$(RESET)"
	@echo "$(YELLOW)è³‡æ–™åº«å¥åº·ç‹€æ…‹:$(RESET)"
	@if $(DOCKER_COMPOSE) -f docker-compose.db.yml exec -T db pg_isready -U $${DB_USERNAME:-phantom_user} >/dev/null 2>&1; then \
		echo "$(GREEN)âœ… è³‡æ–™åº«æœå‹™æ­£å¸¸$(RESET)"; \
	else \
		echo "$(RED)âŒ è³‡æ–™åº«æœå‹™ç•°å¸¸$(RESET)"; \
	fi
	@echo "$(YELLOW)å¾Œç«¯å¥åº·ç‹€æ…‹:$(RESET)"
	@if command -v curl >/dev/null 2>&1; then \
		if curl -f http://localhost:$${PORT:-3000}/api/docs >/dev/null 2>&1; then \
			echo "$(GREEN)âœ… å¾Œç«¯æœå‹™æ­£å¸¸$(RESET)"; \
		else \
			echo "$(RED)âŒ å¾Œç«¯æœå‹™ç•°å¸¸æˆ–æœªå•Ÿå‹•$(RESET)"; \
		fi; \
	else \
		echo "$(YELLOW)âš ï¸  ç„¡æ³•æª¢æŸ¥å¾Œç«¯å¥åº·ç‹€æ…‹ (curl æœªå®‰è£)$(RESET)"; \
	fi

separated-logs: ## ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰åˆ†é›¢å¼æœå‹™æ—¥èªŒ
	@echo "$(BLUE)ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰åˆ†é›¢å¼æœå‹™æ—¥èªŒ:$(RESET)"
	@echo "$(YELLOW)=== è³‡æ–™åº«æ—¥èªŒ ====$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml logs --tail=20 2>/dev/null || echo "è³‡æ–™åº«æœå‹™æœªé‹è¡Œ"
	@echo ""
	@echo "$(YELLOW)=== å¾Œç«¯æ—¥èªŒ ====$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml logs --tail=20 2>/dev/null || echo "å¾Œç«¯æœå‹™æœªé‹è¡Œ"

separated-down: ## ğŸ›‘ åœæ­¢æ‰€æœ‰åˆ†é›¢å¼æœå‹™ (ä¿ç•™è³‡æ–™)
	@echo "$(YELLOW)ğŸ›‘ åœæ­¢æ‰€æœ‰åˆ†é›¢å¼æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml down 2>/dev/null || true
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml down 2>/dev/null || true
	@echo "$(GREEN)âœ… æ‰€æœ‰åˆ†é›¢å¼æœå‹™å·²åœæ­¢$(RESET)"

separated-clean: ## ğŸ§¹ æ¸…ç†åˆ†é›¢å¼æœå‹™ (ä¿ç•™è³‡æ–™å’Œç¶²è·¯)
	@echo "$(YELLOW)ğŸ§¹ æ¸…ç†åˆ†é›¢å¼æœå‹™å®¹å™¨...$(RESET)"
	@$(DOCKER_COMPOSE) -f docker-compose.backend.yml down --rmi local 2>/dev/null || true
	@$(DOCKER_COMPOSE) -f docker-compose.db.yml down 2>/dev/null || true
	@echo "$(GREEN)âœ… åˆ†é›¢å¼æœå‹™æ¸…ç†å®Œæˆï¼ˆè³‡æ–™å·²ä¿ç•™ï¼‰$(RESET)"

separated-destroy: ## âš ï¸ å®Œå…¨æ¸…ç†åˆ†é›¢å¼ç’°å¢ƒ (åŒ…å«è³‡æ–™!)
	@echo "$(RED)âš ï¸  è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰åˆ†é›¢å¼æœå‹™çš„è³‡æ–™ï¼$(RESET)"
	@read -p "ç¢ºå®šè¦å®Œå…¨æ¸…ç†ç’°å¢ƒå—ï¼Ÿè¼¸å…¥ 'DELETE' ç¢ºèª: " confirm; \
	if [ "$$confirm" = "DELETE" ]; then \
		echo "$(YELLOW)ğŸ—‘ï¸ å®Œå…¨æ¸…ç†åˆ†é›¢å¼ç’°å¢ƒ...$(RESET)"; \
		$(DOCKER_COMPOSE) -f docker-compose.backend.yml down -v --rmi all 2>/dev/null || true; \
		$(DOCKER_COMPOSE) -f docker-compose.db.yml down -v --rmi all 2>/dev/null || true; \
		docker network rm phantom_network 2>/dev/null || true; \
		docker volume rm phantom_db_data 2>/dev/null || true; \
		echo "$(GREEN)âœ… åˆ†é›¢å¼ç’°å¢ƒå·²å®Œå…¨æ¸…ç†$(RESET)"; \
	else \
		echo "$(BLUE)âŒ å·²å–æ¶ˆæ¸…ç†æ“ä½œ$(RESET)"; \
	fi

# ==========================================
# ğŸ”„ æ•´åˆå¼æ¶æ§‹å‘½ä»¤ (å‚³çµ±æ¨¡å¼)
# ==========================================

setup: ## åˆå§‹åŒ–å°ˆæ¡ˆç’°å¢ƒ
	@make validate-tools
	@echo "$(GREEN)ğŸš€ åˆå§‹åŒ– Phantom Mask Backend ç’°å¢ƒ...$(RESET)"
	@if [ ! -f .env ]; then \
		cp .env.example .env && \
		echo "$(YELLOW)ğŸ“‹ å·²å»ºç«‹ .env æª”æ¡ˆï¼Œè«‹ä¿®æ”¹å…¶ä¸­çš„è¨­å®šå€¼$(RESET)"; \
	else \
		echo "$(BLUE)ğŸ“‹ .env æª”æ¡ˆå·²å­˜åœ¨$(RESET)"; \
	fi
	@mkdir -p backups
	@echo "$(GREEN)âœ… ç’°å¢ƒè¨­å®šå®Œæˆï¼è«‹æª¢æŸ¥ä¸¦ä¿®æ”¹ .env æª”æ¡ˆä¸­çš„è¨­å®š$(RESET)"

up: ## å•Ÿå‹•æ‰€æœ‰æœå‹™ (æ•´åˆæ¨¡å¼)
	@echo "$(GREEN)ğŸš€ å•Ÿå‹•æ‰€æœ‰æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)âœ… æœå‹™å•Ÿå‹•å®Œæˆï¼$(RESET)"
	@make status

down: ## åœæ­¢æ‰€æœ‰æœå‹™ (æ•´åˆæ¨¡å¼)
	@echo "$(YELLOW)ğŸ›‘ åœæ­¢æ‰€æœ‰æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) down
	@echo "$(GREEN)âœ… æœå‹™å·²åœæ­¢$(RESET)"

restart: ## é‡æ–°å•Ÿå‹•æ‰€æœ‰æœå‹™ (æ•´åˆæ¨¡å¼)
	@echo "$(YELLOW)ğŸ”„ é‡æ–°å•Ÿå‹•æ‰€æœ‰æœå‹™...$(RESET)"
	@$(DOCKER_COMPOSE) restart
	@echo "$(GREEN)âœ… æœå‹™é‡æ–°å•Ÿå‹•å®Œæˆï¼$(RESET)"
	@make status

status: ## æª¢æŸ¥æœå‹™ç‹€æ…‹ (æ•´åˆæ¨¡å¼)
	@echo "$(BLUE)ğŸ“Š æœå‹™ç‹€æ…‹:$(RESET)"
	@$(DOCKER_COMPOSE) ps

logs: ## æŸ¥çœ‹æ‰€æœ‰æœå‹™æ—¥èªŒ (æ•´åˆæ¨¡å¼)
	@echo "$(BLUE)ğŸ“‹ æŸ¥çœ‹æœå‹™æ—¥èªŒ:$(RESET)"
	@$(DOCKER_COMPOSE) logs --tail=50 -f

logs-backend: ## æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ (æ•´åˆæ¨¡å¼)
	@echo "$(BLUE)ğŸ“‹ æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ:$(RESET)"
	@$(DOCKER_COMPOSE) logs --tail=50 -f backend

logs-db: ## æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ (æ•´åˆæ¨¡å¼)
	@echo "$(BLUE)ğŸ“‹ æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ:$(RESET)"
	@$(DOCKER_COMPOSE) logs --tail=50 -f db

build: ## é‡æ–°å»ºç½®æ‰€æœ‰æ˜ åƒæª” (æ•´åˆæ¨¡å¼)
	@echo "$(GREEN)ğŸ”¨ é‡æ–°å»ºç½®æ˜ åƒæª”...$(RESET)"
	@$(DOCKER_COMPOSE) build --no-cache
	@echo "$(GREEN)âœ… æ˜ åƒæª”å»ºç½®å®Œæˆï¼$(RESET)"

build-backend: ## åªé‡æ–°å»ºç½®å¾Œç«¯æ˜ åƒæª” (æ•´åˆæ¨¡å¼)
	@echo "$(GREEN)ğŸ”¨ é‡æ–°å»ºç½®å¾Œç«¯æ˜ åƒæª”...$(RESET)"
	@$(DOCKER_COMPOSE) build --no-cache backend
	@echo "$(GREEN)âœ… å¾Œç«¯æ˜ åƒæª”å»ºç½®å®Œæˆï¼$(RESET)"

shell-backend: ## é€²å…¥å¾Œç«¯å®¹å™¨ shell (æ•´åˆæ¨¡å¼)
	@echo "$(BLUE)ğŸš é€²å…¥å¾Œç«¯å®¹å™¨...$(RESET)"
	@$(DOCKER_COMPOSE) exec backend sh

shell-db: ## é€²å…¥è³‡æ–™åº«å®¹å™¨ (æ•´åˆæ¨¡å¼)
	@echo "$(BLUE)ğŸš é€£æ¥åˆ°è³‡æ–™åº«...$(RESET)"
	@$(DOCKER_COMPOSE) exec db psql -U $${DB_USERNAME:-phantom_user} -d $${DB_NAME:-phantom_mask_db}

db-backup: ## å‚™ä»½è³‡æ–™åº« (æ•´åˆæ¨¡å¼)
	@echo "$(GREEN)ğŸ’¾ å»ºç«‹è³‡æ–™åº«å‚™ä»½...$(RESET)"
	@mkdir -p backups
	@BACKUP_FILE="backups/backup_$(shell date +%Y%m%d_%H%M%S).sql"; \
	$(DOCKER_COMPOSE) exec -T db pg_dump -U $${DB_USERNAME:-phantom_user} $${DB_NAME:-phantom_mask_db} > $$BACKUP_FILE; \
	echo "$(GREEN)âœ… å‚™ä»½å·²å„²å­˜è‡³: $$BACKUP_FILE$(RESET)"

db-restore: ## é‚„åŸè³‡æ–™åº« (ä½¿ç”¨æ–¹å¼: make db-restore FILE=backup.sql)
	@if [ -z "$(FILE)" ]; then \
		echo "$(RED)âŒ è«‹æŒ‡å®šå‚™ä»½æª”æ¡ˆï¼šmake db-restore FILE=backup.sql$(RESET)"; \
		exit 1; \
	fi
	@if [ ! -f "$(FILE)" ]; then \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°æª”æ¡ˆ: $(FILE)$(RESET)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)âš ï¸  è­¦å‘Šï¼šé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™åº«ï¼$(RESET)"
	@read -p "ç¢ºå®šè¦é‚„åŸè³‡æ–™åº«å—ï¼Ÿ(y/N) " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		echo "$(GREEN)ğŸ“¥ é‚„åŸè³‡æ–™åº«...$(RESET)"; \
		$(DOCKER_COMPOSE) exec -T db psql -U $${DB_USERNAME:-phantom_user} -d $${DB_NAME:-phantom_mask_db} < $(FILE); \
		echo "$(GREEN)âœ… è³‡æ–™åº«é‚„åŸå®Œæˆï¼$(RESET)"; \
	else \
		echo "$(BLUE)âŒ å·²å–æ¶ˆé‚„åŸæ“ä½œ$(RESET)"; \
	fi

# ==========================================
# ğŸ”§ é–‹ç™¼å’Œç¶­è­·å·¥å…·
# ==========================================

dev: ## å•Ÿå‹•é–‹ç™¼ç’°å¢ƒï¼ˆåƒ…è³‡æ–™åº«ï¼‰
	@echo "$(GREEN)ğŸ’» å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ...$(RESET)"
	@if [ ! -f docker-compose.dev.yml ]; then \
		echo "services:\n  db:\n    image: postgres:15\n    container_name: phantom_db_dev\n    environment:\n      POSTGRES_USER: \$${DB_USERNAME}\n      POSTGRES_PASSWORD: \$${DB_PASSWORD}\n      POSTGRES_DB: \$${DB_NAME}\n    ports:\n      - \"\$${DB_PORT}:5432\"\n    volumes:\n      - db_data_dev:/var/lib/postgresql/data\n      - ./extractDB/sql:/docker-entrypoint-initdb.d\n\nvolumes:\n  db_data_dev:" > docker-compose.dev.yml; \
		echo "$(YELLOW)ğŸ“‹ å·²å»ºç«‹ docker-compose.dev.yml$(RESET)"; \
	fi
	@$(DOCKER_COMPOSE) -f docker-compose.dev.yml up -d db
	@echo "$(GREEN)âœ… é–‹ç™¼ç’°å¢ƒå•Ÿå‹•å®Œæˆï¼$(RESET)"
	@echo "$(BLUE)ğŸ’¡ ç¾åœ¨å¯ä»¥ä½¿ç”¨ 'npm run start:dev' å•Ÿå‹•å¾Œç«¯æœå‹™$(RESET)"

prod: ## å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒ
	@echo "$(GREEN)ğŸ­ å•Ÿå‹•ç”Ÿç”¢ç’°å¢ƒ...$(RESET)"
	@NODE_ENV=production $(DOCKER_COMPOSE) up -d --build
	@echo "$(GREEN)âœ… ç”Ÿç”¢ç’°å¢ƒå•Ÿå‹•å®Œæˆï¼$(RESET)"
	@make status

migration-run: ## åŸ·è¡Œè³‡æ–™åº« migration
	@echo "$(GREEN)ğŸ—‚ï¸  åŸ·è¡Œè³‡æ–™åº« migration...$(RESET)"
	@if $(DOCKER_COMPOSE) ps 2>/dev/null | grep -q phantom_backend_integrated; then \
		$(DOCKER_COMPOSE) exec backend npm run migration:run; \
	elif $(DOCKER_COMPOSE) -f docker-compose.backend.yml ps 2>/dev/null | grep -q phantom_backend_dev; then \
		$(DOCKER_COMPOSE) -f docker-compose.backend.yml exec backend npm run migration:run; \
	else \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°é‹è¡Œä¸­çš„å¾Œç«¯æœå‹™$(RESET)"; \
		echo "$(YELLOW)ğŸ’¡ è«‹å…ˆå•Ÿå‹•å¾Œç«¯æœå‹™ï¼šmake backend-start æˆ– make up$(RESET)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… Migration åŸ·è¡Œå®Œæˆï¼$(RESET)"

migration-revert: ## å›æ»¾è³‡æ–™åº« migration
	@echo "$(YELLOW)âª å›æ»¾è³‡æ–™åº« migration...$(RESET)"
	@if $(DOCKER_COMPOSE) ps 2>/dev/null | grep -q phantom_backend_integrated; then \
		$(DOCKER_COMPOSE) exec backend npm run migration:revert; \
	elif $(DOCKER_COMPOSE) -f docker-compose.backend.yml ps 2>/dev/null | grep -q phantom_backend_dev; then \
		$(DOCKER_COMPOSE) -f docker-compose.backend.yml exec backend npm run migration:revert; \
	else \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°é‹è¡Œä¸­çš„å¾Œç«¯æœå‹™$(RESET)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… Migration å›æ»¾å®Œæˆï¼$(RESET)"

migration-generate: ## ç”¢ç”Ÿæ–°çš„ migration (ä½¿ç”¨æ–¹å¼: make migration-generate NAME=AddUserTable)
	@if [ -z "$(NAME)" ]; then \
		echo "$(RED)âŒ è«‹æŒ‡å®š migration åç¨±ï¼šmake migration-generate NAME=AddUserTable$(RESET)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ“ ç”¢ç”Ÿæ–°çš„ migration: $(NAME)...$(RESET)"
	@if $(DOCKER_COMPOSE) ps 2>/dev/null | grep -q phantom_backend_integrated; then \
		$(DOCKER_COMPOSE) exec backend npm run migration:generate -- src/migrations/$(NAME); \
	elif $(DOCKER_COMPOSE) -f docker-compose.backend.yml ps 2>/dev/null | grep -q phantom_backend_dev; then \
		$(DOCKER_COMPOSE) -f docker-compose.backend.yml exec backend npm run migration:generate -- src/migrations/$(NAME); \
	else \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°é‹è¡Œä¸­çš„å¾Œç«¯æœå‹™$(RESET)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… Migration æª”æ¡ˆå·²ç”¢ç”Ÿï¼$(RESET)"

test: ## åŸ·è¡Œæ¸¬è©¦
	@echo "$(GREEN)ğŸ§ª åŸ·è¡Œæ¸¬è©¦...$(RESET)"
	@if $(DOCKER_COMPOSE) ps 2>/dev/null | grep -q phantom_backend_integrated; then \
		$(DOCKER_COMPOSE) exec backend npm run test; \
	elif $(DOCKER_COMPOSE) -f docker-compose.backend.yml ps 2>/dev/null | grep -q phantom_backend_dev; then \
		$(DOCKER_COMPOSE) -f docker-compose.backend.yml exec backend npm run test; \
	else \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°é‹è¡Œä¸­çš„å¾Œç«¯æœå‹™$(RESET)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… æ¸¬è©¦å®Œæˆï¼$(RESET)"

test-e2e: ## åŸ·è¡Œç«¯å°ç«¯æ¸¬è©¦
	@echo "$(GREEN)ğŸ§ª åŸ·è¡Œç«¯å°ç«¯æ¸¬è©¦...$(RESET)"
	@if $(DOCKER_COMPOSE) ps 2>/dev/null | grep -q phantom_backend_integrated; then \
		$(DOCKER_COMPOSE) exec backend npm run test:e2e; \
	elif $(DOCKER_COMPOSE) -f docker-compose.backend.yml ps 2>/dev/null | grep -q phantom_backend_dev; then \
		$(DOCKER_COMPOSE) -f docker-compose.backend.yml exec backend npm run test:e2e; \
	else \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°é‹è¡Œä¸­çš„å¾Œç«¯æœå‹™$(RESET)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… E2E æ¸¬è©¦å®Œæˆï¼$(RESET)"

health: ## æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹
	@echo "$(BLUE)ğŸ¥ æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹...$(RESET)"
	@echo "$(YELLOW)å¾Œç«¯æœå‹™:$(RESET)"
	@if command -v curl >/dev/null 2>&1; then \
		if curl -s http://localhost:$${PORT:-3000}/api/docs >/dev/null 2>&1; then \
			echo "$(GREEN)âœ… å¾Œç«¯æœå‹™æ­£å¸¸$(RESET)"; \
		else \
			echo "$(RED)âŒ å¾Œç«¯æœå‹™ç„¡å›æ‡‰$(RESET)"; \
		fi; \
	else \
		echo "$(YELLOW)âš ï¸  ç„¡æ³•æª¢æŸ¥å¾Œç«¯ç‹€æ…‹ (curl æœªå®‰è£)$(RESET)"; \
	fi
	@echo "$(YELLOW)è³‡æ–™åº«æœå‹™:$(RESET)"
	@if $(DOCKER_COMPOSE) ps 2>/dev/null | grep -q phantom_db_integrated; then \
		$(DOCKER_COMPOSE) exec db pg_isready -U $${DB_USERNAME:-phantom_user} && echo "$(GREEN)âœ… è³‡æ–™åº«æœå‹™æ­£å¸¸$(RESET)" || echo "$(RED)âŒ è³‡æ–™åº«æœå‹™ç•°å¸¸$(RESET)"; \
	elif $(DOCKER_COMPOSE) -f docker-compose.db.yml ps 2>/dev/null | grep -q phantom_db_persistent; then \
		$(DOCKER_COMPOSE) -f docker-compose.db.yml exec db pg_isready -U $${DB_USERNAME:-phantom_user} && echo "$(GREEN)âœ… è³‡æ–™åº«æœå‹™æ­£å¸¸$(RESET)" || echo "$(RED)âŒ è³‡æ–™åº«æœå‹™ç•°å¸¸$(RESET)"; \
	else \
		echo "$(RED)âŒ æ‰¾ä¸åˆ°é‹è¡Œä¸­çš„è³‡æ–™åº«æœå‹™$(RESET)"; \
	fi

monitor: ## ç›£æ§å®¹å™¨è³‡æºä½¿ç”¨æƒ…æ³
	@echo "$(BLUE)ğŸ“Š å®¹å™¨è³‡æºç›£æ§ (æŒ‰ Ctrl+C çµæŸ):$(RESET)"
	@docker stats

clean: ## æ¸…ç†æœªä½¿ç”¨çš„ Docker è³‡æº
	@echo "$(YELLOW)ğŸ§¹ æ¸…ç† Docker è³‡æº...$(RESET)"
	@read -p "é€™å°‡æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„ Docker æ˜ åƒæª”ã€å®¹å™¨å’Œç¶²è·¯ã€‚ç¹¼çºŒå—ï¼Ÿ(y/N) " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker system prune -a -f; \
		echo "$(GREEN)âœ… æ¸…ç†å®Œæˆï¼$(RESET)"; \
	else \
		echo "$(BLUE)âŒ å·²å–æ¶ˆæ¸…ç†æ“ä½œ$(RESET)"; \
	fi

clean-all: ## æ¸…ç†æ‰€æœ‰è³‡æºï¼ˆåŒ…å« volumesï¼‰
	@echo "$(RED)âš ï¸  è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼$(RESET)"
	@read -p "ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å®¹å™¨ã€æ˜ åƒæª”å’Œè³‡æ–™å—ï¼Ÿ(y/N) " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		$(DOCKER_COMPOSE) down -v --rmi all 2>/dev/null || true; \
		docker system prune -a -f; \
		echo "$(GREEN)âœ… å®Œå…¨æ¸…ç†å®Œæˆï¼$(RESET)"; \
	else \
		echo "$(BLUE)âŒ å·²å–æ¶ˆæ¸…ç†æ“ä½œ$(RESET)"; \
	fi

config: ## æª¢æŸ¥ Docker Compose é…ç½®
	@echo "$(BLUE)âš™ï¸  Docker Compose é…ç½®:$(RESET)"
	@$(DOCKER_COMPOSE) config

update: ## æ›´æ–°å°ˆæ¡ˆï¼ˆæ‹‰å–æœ€æ–°ä»£ç¢¼ä¸¦é‡æ–°å»ºç½®ï¼‰
	@echo "$(GREEN)ğŸ”„ æ›´æ–°å°ˆæ¡ˆ...$(RESET)"
	@if command -v git >/dev/null 2>&1; then \
		make db-backup; \
		git pull origin main; \
		make build; \
		make up; \
		echo "$(GREEN)âœ… å°ˆæ¡ˆæ›´æ–°å®Œæˆï¼$(RESET)"; \
	else \
		echo "$(RED)âŒ Git æœªå®‰è£ï¼Œç„¡æ³•æ›´æ–°å°ˆæ¡ˆ$(RESET)"; \
		exit 1; \
	fi

quick-start: setup up ## å¿«é€Ÿé–‹å§‹ï¼ˆè¨­å®šç’°å¢ƒä¸¦å•Ÿå‹•æœå‹™ï¼‰
	@echo "$(GREEN)ğŸ‰ Phantom Mask Backend å·²æº–å‚™å°±ç·’ï¼$(RESET)"
	@echo "$(BLUE)ğŸ’¡ æ¥ä¸‹ä¾†å¯ä»¥ï¼š$(RESET)"
	@echo "   â€¢ æŸ¥çœ‹æœå‹™ç‹€æ…‹: make status"
	@echo "   â€¢ æŸ¥çœ‹æ—¥èªŒ: make logs"
	@echo "   â€¢ é€²å…¥å¾Œç«¯å®¹å™¨: make shell-backend"
	@echo "   â€¢ åŸ·è¡Œ migration: make migration-run"

quick-start-separated: separated-init backend-start ## ğŸš€ å¿«é€Ÿé–‹å§‹åˆ†é›¢å¼æ¶æ§‹
	@echo "$(GREEN)ğŸ‰ åˆ†é›¢å¼ Phantom Mask Backend å·²æº–å‚™å°±ç·’ï¼$(RESET)"
	@echo "$(BLUE)ğŸ’¡ åˆ†é›¢å¼æ¶æ§‹å„ªå‹¢ï¼š$(RESET)"
	@echo "   â€¢ è³‡æ–™åº«ç¨ç«‹é‹è¡Œï¼Œè³‡æ–™æ›´å®‰å…¨"
	@echo "   â€¢ å¾Œç«¯å¯éš¨æ™‚é‡å»ºè€Œä¸å½±éŸ¿è³‡æ–™"
	@echo "   â€¢ é–‹ç™¼æ™‚å¯åªé‡æ–°éƒ¨ç½²éœ€è¦çš„æœå‹™"
	@echo ""
	@echo "$(BLUE)ğŸ’¡ å¸¸ç”¨å‘½ä»¤ï¼š$(RESET)"
	@echo "   â€¢ æŸ¥çœ‹æœå‹™ç‹€æ…‹: make separated-status"
	@echo "   â€¢ å®‰å…¨é‡å»ºå¾Œç«¯: make backend-rebuild"
	@echo "   â€¢ åŸ·è¡Œ migration: make migration-run"
	@echo "   â€¢ æª¢æŸ¥å¥åº·ç‹€æ…‹: make separated-health"

validate-makefile: ## ğŸ”§ é©—è­‰ Makefile æ‰€æœ‰å‘½ä»¤
	@echo "$(BLUE)ğŸ”§ é©—è­‰ Makefile æ‰€æœ‰å‘½ä»¤...$(RESET)"
	@echo ""
	@echo "$(YELLOW)æª¢æŸ¥èªæ³•...$(RESET)"
	@make -n help >/dev/null 2>&1 && echo "$(GREEN)âœ… Makefile èªæ³•æ­£ç¢º$(RESET)" || echo "$(RED)âŒ Makefile èªæ³•éŒ¯èª¤$(RESET)"
	@echo ""
	@echo "$(YELLOW)æª¢æŸ¥æ‰€æœ‰ç›®æ¨™...$(RESET)"
	@TARGETS=$$(make -qp | grep -E '^[a-zA-Z_-]+:' | grep -v '^#' | cut -d':' -f1 | sort -u); \
	for target in $$TARGETS; do \
		if [ "$$target" != "Makefile" ] && [ "$$target" != ".PHONY" ]; then \
			if make -n "$$target" >/dev/null 2>&1; then \
				echo "$(GREEN)âœ… $$target$(RESET)"; \
			else \
				echo "$(RED)âŒ $$target$(RESET)"; \
			fi; \
		fi; \
	done

# ==========================================
# ğŸ”§ è¼”åŠ©å‡½æ•¸
# ==========================================

_check-db-running: ## å…§éƒ¨ï¼šæª¢æŸ¥è³‡æ–™åº«æ˜¯å¦é‹è¡Œ
	@if ! $(DOCKER_COMPOSE) -f docker-compose.db.yml ps 2>/dev/null | grep -q "phantom_db_persistent.*Up"; then \
		echo "$(RED)âŒ è³‡æ–™åº«æœå‹™æœªé‹è¡Œï¼è«‹å…ˆåŸ·è¡Œ 'make db-start'$(RESET)"; \
		exit 1; \
	fi

_wait-for-db: ## å…§éƒ¨ï¼šç­‰å¾…è³‡æ–™åº«å°±ç·’
	@echo "$(BLUE)â³ ç­‰å¾…è³‡æ–™åº«æœå‹™å°±ç·’...$(RESET)"
	@timeout=60; \
	while [ $$timeout -gt 0 ]; do \
		if $(DOCKER_COMPOSE) -f docker-compose.db.yml exec -T db pg_isready -U $${DB_USERNAME:-phantom_user} >/dev/null 2>&1; then \
			echo "$(GREEN)âœ… è³‡æ–™åº«æœå‹™å°±ç·’ï¼$(RESET)"; \
			break; \
		fi; \
		sleep 2; \
		timeout=$$((timeout-2)); \
	done; \
	if [ $$timeout -le 0 ]; then \
		echo "$(RED)âŒ è³‡æ–™åº«æœå‹™å•Ÿå‹•è¶…æ™‚$(RESET)"; \
		exit 1; \
	fi

_wait-for-backend: ## å…§éƒ¨ï¼šç­‰å¾…å¾Œç«¯æœå‹™å°±ç·’
	@echo "$(BLUE)â³ ç­‰å¾…å¾Œç«¯æœå‹™å°±ç·’...$(RESET)"
	@if command -v curl >/dev/null 2>&1; then \
		timeout=60; \
		while [ $$timeout -gt 0 ]; do \
			if curl -f http://localhost:$${PORT:-3000}/api/docs >/dev/null 2>&1; then \
				echo "$(GREEN)âœ… å¾Œç«¯æœå‹™å°±ç·’ï¼$(RESET)"; \
				break; \
			fi; \
			sleep 2; \
			timeout=$$((timeout-2)); \
		done; \
		if [ $$timeout -le 0 ]; then \
			echo "$(RED)âŒ å¾Œç«¯æœå‹™å•Ÿå‹•è¶…æ™‚$(RESET)"; \
			exit 1; \
		fi; \
	else \
		echo "$(YELLOW)âš ï¸  ç„¡æ³•é©—è­‰å¾Œç«¯æœå‹™ç‹€æ…‹ (curl æœªå®‰è£)ï¼Œç­‰å¾… 10 ç§’...$(RESET)"; \
		sleep 10; \
	fi

# éš±è—ç›®æ¨™ï¼ˆä¸åœ¨ help ä¸­é¡¯ç¤ºï¼‰
_check-env:
	@if [ ! -f .env ]; then \
		echo "$(RED)âŒ æ‰¾ä¸åˆ° .env æª”æ¡ˆï¼Œè«‹å…ˆåŸ·è¡Œ 'make setup'$(RESET)"; \
		exit 1; \
	fi

_init-db-if-needed: ## å…§éƒ¨ï¼šæª¢æŸ¥ä¸¦åˆå§‹åŒ–è³‡æ–™åº«
	@echo "$(BLUE)ğŸ—‚ï¸  æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦éœ€è¦åˆå§‹åŒ–...$(RESET)"
	@if ! $(DOCKER_COMPOSE) -f docker-compose.db.yml exec -T db psql -U $${DB_USERNAME:-phantom_user} -d $${DB_NAME:-phantom_mask_db} -c "SELECT 1 FROM pg_tables WHERE schemaname = 'public' AND tablename != 'migrations' LIMIT 1;" | grep -q "1" 2>/dev/null; then \
		echo "$(YELLOW)ğŸ“‹ è³‡æ–™åº«ç‚ºç©ºï¼Œé–‹å§‹åˆå§‹åŒ–...$(RESET)"; \
		echo "$(BLUE)ğŸš€ å•Ÿå‹•è‡¨æ™‚å¾Œç«¯å®¹å™¨ä»¥åŸ·è¡Œ migration...$(RESET)"; \
		$(DOCKER_COMPOSE) -f docker-compose.backend.yml up -d --no-deps --build backend; \
		echo "$(BLUE)â³ ç­‰å¾…å¾Œç«¯å®¹å™¨å•Ÿå‹•...$(RESET)"; \
		sleep 20; \
		echo "$(GREEN)ğŸ—‚ï¸  åªåŸ·è¡ŒåŸºç¤è³‡æ–™è¡¨ migration...$(RESET)"; \
		if $(DOCKER_COMPOSE) -f docker-compose.backend.yml exec backend npx typeorm migration:run -d dist/data-source.js --transaction each; then \
			echo "$(GREEN)âœ… è³‡æ–™åº«åŸºç¤çµæ§‹åˆå§‹åŒ–å®Œæˆï¼$(RESET)"; \
		else \
			echo "$(YELLOW)âš ï¸  Migration æœ‰éƒ¨åˆ†å•é¡Œï¼Œä½†åŸºç¤çµæ§‹å¯èƒ½å·²å»ºç«‹$(RESET)"; \
		fi; \
		echo "$(BLUE)ğŸ›‘ åœæ­¢è‡¨æ™‚å¾Œç«¯å®¹å™¨...$(RESET)"; \
		$(DOCKER_COMPOSE) -f docker-compose.backend.yml stop backend; \
	else \
		echo "$(GREEN)âœ… è³‡æ–™åº«å·²å­˜åœ¨ï¼Œè·³éåˆå§‹åŒ–$(RESET)"; \
	fi