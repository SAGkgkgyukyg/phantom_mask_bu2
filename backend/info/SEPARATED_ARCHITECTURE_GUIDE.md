# åˆ†é›¢å¼ Docker æ¶æ§‹æŒ‡å—

## ğŸ—ï¸ æ¶æ§‹æ¦‚è¿°

åˆ†é›¢å¼æ¶æ§‹å°‡è³‡æ–™åº«å’Œå¾Œç«¯æœå‹™å®Œå…¨åˆ†é–‹ç®¡ç†ï¼Œæä¾›æ›´å¥½çš„ç©©å®šæ€§å’Œé–‹ç™¼å½ˆæ€§ã€‚

### æ¶æ§‹æ¯”è¼ƒ

| ç‰¹é»         | æ•´åˆå¼æ¶æ§‹     | åˆ†é›¢å¼æ¶æ§‹ âœ¨     |
| ------------ | -------------- | ----------------- |
| è³‡æ–™åº«ç©©å®šæ€§ | èˆ‡å¾Œç«¯ä¸€èµ·é‡å•Ÿ | å®Œå…¨ç¨ç«‹é‹è¡Œ      |
| é–‹ç™¼å½ˆæ€§     | éœ€è¦åŒæ™‚ç®¡ç†   | å¯å–®ç¨æ›´æ–°å¾Œç«¯    |
| è³‡æ–™å®‰å…¨æ€§   | ä¸€èˆ¬           | **é«˜** - è‡ªå‹•å‚™ä»½ |
| è³‡æºä½¿ç”¨     | è¼ƒé«˜           | è¼ƒä½              |
| éƒ¨ç½²è¤‡é›œåº¦   | ç°¡å–®           | ä¸­ç­‰              |

## ğŸš€ å¿«é€Ÿé–‹å§‹

### æ–¹æ³• 1: ä¸€éµå•Ÿå‹•

```bash
# è‡ªå‹•åˆå§‹åŒ–ä¸¦å•Ÿå‹•åˆ†é›¢å¼ç’°å¢ƒ
make quick-start-separated
```

### æ–¹æ³• 2: é€æ­¥å•Ÿå‹•

```bash
# 1. åˆå§‹åŒ–ç’°å¢ƒï¼ˆå»ºç«‹ç¶²è·¯ã€å•Ÿå‹•è³‡æ–™åº«ï¼‰
make separated-init

# 2. å•Ÿå‹•å¾Œç«¯æœå‹™
make backend-start

# 3. æª¢æŸ¥æœå‹™ç‹€æ…‹
make separated-status
```

## ğŸ“‹ æœå‹™ç®¡ç†

### è³‡æ–™åº«ç®¡ç†ï¼ˆä¸€æ¬¡å»ºç«‹ï¼Œé•·æœŸä½¿ç”¨ï¼‰

```bash
# å•Ÿå‹•è³‡æ–™åº«æœå‹™
make db-start

# åœæ­¢è³‡æ–™åº«æœå‹™ï¼ˆä¿ç•™è³‡æ–™ï¼‰
make db-stop

# é‡æ–°å•Ÿå‹•è³‡æ–™åº«
make db-restart

# æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ
make db-logs

# é€£æ¥è³‡æ–™åº«
make db-shell
```

### å¾Œç«¯ç®¡ç†ï¼ˆå¯é »ç¹é‡å»ºï¼‰

```bash
# å•Ÿå‹•å¾Œç«¯æœå‹™
make backend-start

# åœæ­¢å¾Œç«¯æœå‹™
make backend-stop

# é‡æ–°å•Ÿå‹•å¾Œç«¯
make backend-restart

# å®‰å…¨é‡å»ºå¾Œç«¯ï¼ˆè‡ªå‹•å‚™ä»½ â†’ é‡å»º â†’ é©—è­‰ï¼‰
make backend-rebuild

# æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ
make backend-logs

# é€²å…¥å¾Œç«¯å®¹å™¨
make backend-shell
```

## ğŸ”„ å®‰å…¨é‡å»ºæµç¨‹

`make backend-rebuild` å‘½ä»¤æä¾›å®Œå…¨è‡ªå‹•åŒ–çš„å®‰å…¨é‡å»ºæµç¨‹ï¼š

1. **ğŸ”’ è‡ªå‹•å‚™ä»½è³‡æ–™åº«**
   - å»ºç«‹å¸¶æ™‚é–“æˆ³è¨˜çš„å‚™ä»½æª”æ¡ˆ
   - é©—è­‰å‚™ä»½å®Œæ•´æ€§

2. **ğŸ›‘ åœæ­¢èˆŠçš„å¾Œç«¯æœå‹™**
   - å„ªé›…åœ°åœæ­¢å®¹å™¨
   - æ¸…ç†èˆŠçš„æ˜ åƒæª”

3. **ğŸ”¨ é‡æ–°å»ºç½®æ˜ åƒæª”**
   - ä½¿ç”¨æœ€æ–°ç¨‹å¼ç¢¼
   - æ¸…é™¤å¿«å–ç¢ºä¿ä¹¾æ·¨å»ºç½®

4. **ğŸš€ å•Ÿå‹•æ–°çš„å¾Œç«¯æœå‹™**
   - ç­‰å¾…æœå‹™å®Œå…¨å°±ç·’
   - è‡ªå‹•å¥åº·æª¢æŸ¥

5. **âœ… é©—è­‰æœå‹™ç‹€æ…‹**
   - æª¢æŸ¥æ‰€æœ‰æœå‹™å¥åº·ç‹€æ…‹
   - ç¢ºä¿ç³»çµ±æ­£å¸¸é‹ä½œ

## ğŸ’¾ å‚™ä»½èˆ‡é‚„åŸ

### è‡ªå‹•å‚™ä»½

```bash
# å»ºç«‹è‡ªå‹•å‚™ä»½ï¼ˆåŒ…å«æ™‚é–“æˆ³è¨˜ï¼‰
make db-backup-auto

# æª¢è¦–å‚™ä»½æª”æ¡ˆ
ls -la backups/
```

### é‚„åŸæœ€æ–°å‚™ä»½

```bash
# è‡ªå‹•é‚„åŸæœ€æ–°çš„å‚™ä»½
make db-restore-latest

# æ‰‹å‹•é‚„åŸæŒ‡å®šå‚™ä»½
make db-restore FILE=backups/auto_backup_20240927_143022.sql
```

## ğŸ“Š ç›£æ§èˆ‡æª¢æŸ¥

### æœå‹™ç‹€æ…‹æª¢æŸ¥

```bash
# æŸ¥çœ‹æ‰€æœ‰åˆ†é›¢å¼æœå‹™ç‹€æ…‹
make separated-status

# æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹
make separated-health

# æŸ¥çœ‹æ‰€æœ‰æœå‹™æ—¥èªŒ
make separated-logs
```

### å¥åº·æª¢æŸ¥è¼¸å‡ºç¯„ä¾‹

```
ğŸ¥ æª¢æŸ¥åˆ†é›¢å¼æœå‹™å¥åº·ç‹€æ…‹...
è³‡æ–™åº«å¥åº·ç‹€æ…‹:
âœ… è³‡æ–™åº«æœå‹™æ­£å¸¸
å¾Œç«¯å¥åº·ç‹€æ…‹:
âœ… å¾Œç«¯æœå‹™æ­£å¸¸
```

## ğŸ—„ï¸ è³‡æ–™åº«é·ç§»

### åŸ·è¡Œ Migration

```bash
# åŸ·è¡Œè³‡æ–™åº« migration
make migration-run

# å›æ»¾ migration
make migration-revert

# ç”¢ç”Ÿæ–°çš„ migration
make migration-generate NAME=AddNewFeature
```

## ğŸ§ª é–‹ç™¼èˆ‡æ¸¬è©¦

### åŸ·è¡Œæ¸¬è©¦

```bash
# åŸ·è¡Œå–®å…ƒæ¸¬è©¦
make test

# åŸ·è¡Œç«¯å°ç«¯æ¸¬è©¦
make test-e2e
```

## ğŸŒ ç¶²è·¯æ¶æ§‹

åˆ†é›¢å¼æ¶æ§‹ä½¿ç”¨ Docker è‡ªè¨‚ç¶²è·¯ `phantom_network`ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            phantom_network              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Database      â”‚ â”‚    Backend      â”‚ â”‚
â”‚  â”‚ (persistent)    â”‚ â”‚  (rebuildable)  â”‚ â”‚
â”‚  â”‚ Port: 5432      â”‚â—„â”¤ Port: 3000      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ Host:5432  â”‚        â”‚ Host:3000  â”‚
    â”‚ (DB Access)â”‚        â”‚ (API)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ç’°å¢ƒé…ç½®

### .env æª”æ¡ˆè¨­å®š

```bash
# åˆ†é›¢å¼æ¶æ§‹çš„é‡è¦è¨­å®š
DB_HOST=localhost  # æœ¬åœ°é–‹ç™¼æ™‚ä½¿ç”¨
# DB_HOST=phantom_db_persistent  # å¦‚æœå¾Œç«¯ä¹Ÿåœ¨ Docker ä¸­

DB_PORT=5432
DB_USERNAME=phantom_user
DB_PASSWORD=your_secure_password
DB_NAME=phantom_mask_db
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. å¾Œç«¯ç„¡æ³•é€£æ¥è³‡æ–™åº«

```bash
# æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦é‹è¡Œ
make db-start

# æª¢æŸ¥ç¶²è·¯é€£é€šæ€§
docker network inspect phantom_network

# é©—è­‰ç’°å¢ƒè®Šæ•¸
grep DB_ .env
```

#### 2. è³‡æ–™åº«æœå‹™ç„¡æ³•å•Ÿå‹•

```bash
# æª¢æŸ¥é€£æ¥åŸ æ˜¯å¦è¢«å ç”¨
lsof -i :5432

# æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ
make db-logs

# é‡æ–°å»ºç«‹ç¶²è·¯
docker network rm phantom_network
make separated-init
```

#### 3. å‚™ä»½å¤±æ•—

```bash
# æª¢æŸ¥å‚™ä»½ç›®éŒ„æ¬Šé™
mkdir -p backups
chmod 755 backups

# æ‰‹å‹•æ¸¬è©¦å‚™ä»½
docker-compose -f docker-compose.db.yml exec db pg_dump -U ${DB_USERNAME} ${DB_NAME}
```

## ğŸ§¹ æ¸…ç†èˆ‡ç¶­è­·

### å®šæœŸç¶­è­·

```bash
# æ¸…ç†åˆ†é›¢å¼æœå‹™å®¹å™¨ï¼ˆä¿ç•™è³‡æ–™ï¼‰
make separated-clean

# æŸ¥çœ‹è³‡æºä½¿ç”¨æƒ…æ³
make monitor
```

### å®Œå…¨é‡ç½®

```bash
# âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼
make separated-destroy
```

## ğŸ“ˆ æ•ˆèƒ½æœ€ä½³åŒ–

### è³‡æ–™åº«æœ€ä½³åŒ–è¨­å®š

docker-compose.db.yml ä¸­å·²åŒ…å«ï¼š

- å¥åº·æª¢æŸ¥
- è³‡æºé™åˆ¶
- å„ªåŒ–çš„åˆå§‹åŒ–åƒæ•¸
- è‡ªå‹•é‡å•Ÿè¨­å®š

### å¾Œç«¯æœ€ä½³åŒ–è¨­å®š

docker-compose.backend.yml ä¸­å·²åŒ…å«ï¼š

- å¥åº·æª¢æŸ¥
- è³‡æºé™åˆ¶
- ä¾è³´é—œä¿‚ç®¡ç†
- ç’°å¢ƒè®Šæ•¸æœ€ä½³åŒ–

## ğŸ”’ å®‰å…¨å»ºè­°

1. **ç’°å¢ƒè®Šæ•¸å®‰å…¨**

   ```bash
   # ç¢ºä¿ .env æª”æ¡ˆæ¬Šé™æ­£ç¢º
   chmod 600 .env
   ```

2. **è³‡æ–™åº«å­˜å–æ§åˆ¶**
   - ä½¿ç”¨å¼·å¯†ç¢¼
   - å®šæœŸæ›´æ–°æ†‘è­‰
   - é™åˆ¶ç¶²è·¯å­˜å–

3. **å®šæœŸå‚™ä»½**
   ```bash
   # è¨­å®šå®šæœŸå‚™ä»½ï¼ˆå¯åŠ å…¥ crontabï¼‰
   0 2 * * * cd /path/to/project && make db-backup-auto
   ```

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [Docker Compose å®Œæ•´æŒ‡å—](./DOCKER_COMPOSE_GUIDE.md)
- [Docker Compose å¿«é€Ÿåƒè€ƒ](./DOCKER_QUICK_REFERENCE.md)
- [å°ˆæ¡ˆ README](./README.md)

---

_åˆ†é›¢å¼æ¶æ§‹è®“æ‚¨çš„é–‹ç™¼æ›´å®‰å…¨ã€æ›´éˆæ´»ï¼_
